<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Manajemen Portofolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDXXt1ZI9WjZhJ0zoKsfInsjWfECK4dWoI",
            authDomain: "richdporto.firebaseapp.com",
            projectId: "richdporto",
            storageBucket: "richdporto.appspot.com",
            messagingSenderId: "720478988067",
            appId: "1:720478988067:web:a21abb0396f99872a38e96",
            measurementId: "G-S793S8TH7V"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Make functions available globally
        window.firebase = {
            auth,
            db,
            provider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1F2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .table-wrapper {
            overflow-x: auto;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Tab Styles */
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #22D3EE; /* cyan-400 */
            color: #E5E7EB; /* gray-200 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1F2937;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
        }
        .btn {
            @apply font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2;
        }
        .btn-primary {
             @apply bg-cyan-600 hover:bg-cyan-700 text-white btn;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-500 text-white btn;
        }
         .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white btn;
        }
        #sync-status {
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div class="text-left">
                    <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Dasbor Portofolio</h1>
                    <p class="text-gray-400 mt-2">Simulasikan, catat, dan analisis portofolio Anda.</p>
                </div>
                <div id="auth-container" class="text-right flex items-center space-x-4">
                     <span id="sync-status" class="text-sm text-gray-400 opacity-0"></span>
                    <button id="login-btn" class="btn-primary">Login dengan Google</button>
                    <div id="user-info" class="hidden items-center">
                        <span id="user-name" class="mr-4 text-gray-300"></span>
                        <button id="logout-btn" class="btn-danger">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-gray-700">
            <nav class="flex space-x-1 md:space-x-4 flex-wrap" aria-label="Tabs">
                <button id="tab-btn-simulator" class="tab-button active py-4 px-1 text-sm md:text-lg font-medium text-gray-400 hover:text-gray-200">Kalkulator & Skenario</button>
                <button id="tab-btn-log" class="tab-button py-4 px-1 text-sm md:text-lg font-medium text-gray-400 hover:text-gray-200">Catatan Portofolio</button>
                <button id="tab-btn-saved" class="tab-button py-4 px-1 text-sm md:text-lg font-medium text-gray-400 hover:text-gray-200">Simulasi Tersimpan</button>
                <button id="tab-btn-performance" class="tab-button py-4 px-1 text-sm md:text-lg font-medium text-gray-400 hover:text-gray-200">Performa</button>
                <button id="tab-btn-backup" class="tab-button py-4 px-1 text-sm md:text-lg font-medium text-gray-400 hover:text-gray-200">Cadangkan / Pulihkan</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Simulator Tab -->
            <div id="tab-content-simulator" class="tab-content active">
                 <div class="card mb-8">
                    <div class="flex justify-between items-center">
                         <h2 class="text-2xl font-semibold">Parameter Simulasi Aktif</h2>
                         <button id="open-sim-params-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Ubah Parameter</button>
                    </div>
                    <div id="active-sim-params-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm border-t border-gray-700 pt-4">
                    </div>
                </div>

                <div class="card mb-8"><h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">Ringkasan Portofolio (Equitas)</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"><div><h3 class="text-gray-400 text-sm font-medium">Total Investasi</h3><p id="summary-total-investment" class="text-2xl font-bold text-green-400">IDR 0</p></div><div><h3 class="text-gray-400 text-sm font-medium">Total Lot</h3><p id="summary-total-lot" class="text-2xl font-bold">0</p></div><div><h3 class="text-gray-400 text-sm font-medium">Harga Rata-rata (NAV per Lembar)</h3><p id="summary-avg-price" class="text-2xl font-bold text-yellow-400">IDR 0</p></div></div></div>
                
                <div class="card mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Tabel Skenario Averaging</h2>
                    <div class="table-wrapper">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-cyan-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Level</th>
                                    <th scope="col" class="px-6 py-3">Harga Beli (Rp)</th>
                                    <th scope="col" class="px-6 py-3">Lot Beli</th>
                                    <th scope="col" class="px-6 py-3">Total Beli (Rp)</th>
                                    <th scope="col" class="px-6 py-3">Yield Dividen</th>
                                    <th scope="col" class="px-6 py-3">Harga Rata-rata (Rp)</th>
                                    <th scope="col" class="px-6 py-3">TP 1 (Rp)</th>
                                    <th scope="col" class="px-6 py-3">TP 2 (Rp)</th>
                                </tr>
                            </thead>
                            <tbody id="scenario-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="simulation-reason-card" class="card mb-8 hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">Alasan Simulasi</h2>
                    <p id="simulation-reason-display" class="text-gray-300 whitespace-pre-wrap"></p>
                </div>

                <div class="card"><h2 class="text-2xl font-semibold mb-6 border-b border-gray-700 pb-3">Kalkulator Target Profit</h2><div id="profit-calc-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end"><div><label for="target-profit-rp" class="block text-sm font-medium text-gray-300 mb-1">Target Profit (Rp)</label><input type="number" id="target-profit-rp" value="5000000" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div><div><label for="target-profit-lot" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Lot</label><input type="number" id="target-profit-lot" value="20" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div><div><label for="target-profit-percent" class="block text-sm font-medium text-gray-300 mb-1">Keuntungan (%)</label><input type="number" id="target-profit-percent" value="25" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div></div><div class="mt-6 text-center bg-gray-700/50 p-4 rounded-lg"><h3 class="text-gray-400 text-md font-medium">Estimasi Harga Entry Maksimal</h3><p id="entry-price-result" class="text-2xl md:text-3xl font-bold text-cyan-400 mt-2">IDR 0</p></div></div>
            </div>

            <!-- Portfolio Log Tab -->
            <div id="tab-content-log" class="tab-content">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Riwayat Transaksi</h2><button id="open-add-log-modal-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Tambah Transaksi</button></div><div class="table-wrapper"><table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-cyan-300 uppercase bg-gray-700"><tr><th scope="col" class="px-6 py-3">Tgl Beli</th><th scope="col" class="px-6 py-3">Kode</th><th scope="col" class="px-6 py-3">Harga Beli</th><th scope="col" class="px-6 py-3">Lot</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Tgl Jual</th><th scope="col" class="px-6 py-3">Realisasi P/L</th><th scope="col" class="px-6 py-3">Aksi</th></tr></thead><tbody id="log-table-body"></tbody></table></div></div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="card sticky top-8">
                            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">Ringkasan Portofolio</h2>
                            <div id="equity-monitoring" class="mb-4">
                                <div class="mb-2">
                                    <label for="initial-equity" class="block text-sm font-medium text-gray-300 mb-1">Modal Awal</label>
                                    <input type="number" id="initial-equity" value="100000000" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5">
                                </div>
                                <div class="p-4 bg-gray-600 rounded-lg text-center">
                                    <h4 class="text-gray-300 font-medium">Equitas / Cash Tersedia</h4>
                                    <p id="current-equity-display" class="text-2xl font-bold text-cyan-400 mt-1">IDR 0</p>
                                </div>
                            </div>
                            <div id="portfolio-grand-total" class="mb-4"></div>
                            <div id="realized-pl-summary" class="mb-4"></div>
                            <div id="floating-pl-summary" class="mb-4"></div>
                            <div id="portfolio-summary-by-stock" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Simulations Tab -->
            <div id="tab-content-saved" class="tab-content">
                <div class="card"><h2 class="text-2xl font-semibold mb-4">Daftar Simulasi Tersimpan</h2><div class="table-wrapper"><table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-cyan-300 uppercase bg-gray-700"><tr><th scope="col" class="px-6 py-3">Kode Saham</th><th scope="col" class="px-6 py-3">Harga Awal</th><th scope="col" class="px-6 py-3">Lot Awal</th><th scope="col" class="px-6 py-3">Avg. Down (%)</th><th scope="col" class="px-6 py-3">Jml. Level</th><th scope="col" class="px-6 py-3">Aksi</th></tr></thead><tbody id="saved-simulations-table-body"></tbody></table></div></div>
            </div>

            <!-- Performance Tab -->
            <div id="tab-content-performance" class="tab-content">
                 <div class="card">
                    <h2 class="text-2xl font-semibold mb-4">Performa Portofolio vs IHSG</h2>
                    <p class="text-sm text-gray-400 mb-6">Performa "All Time" dihitung secara otomatis berdasarkan modal awal, transaksi, dan nilai floating P/L. Performa IHSG dapat diisi manual untuk perbandingan.</p>
                    
                    <div class="mb-8 p-4 bg-gray-800/50 rounded-lg">
                        <canvas id="performanceChart"></canvas>
                    </div>

                    <div class="table-wrapper">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-cyan-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Periode</th>
                                    <th scope="col" class="px-6 py-3">Performa Portofolio</th>
                                    <th scope="col" class="px-6 py-3">Performa IHSG (%)</th>
                                    <th scope="col" class="px-6 py-3">Selisih (Alpha)</th>
                                </tr>
                            </thead>
                            <tbody id="performance-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Backup/Restore Tab -->
            <div id="tab-content-backup" class="tab-content">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4">Pencadangan & Pemulihan Lokal</h2>
                    <p class="text-gray-400 mb-6">Simpan data portofolio dan simulasi Anda ke sebuah file di komputer Anda, atau pulihkan dari file yang sudah ada. Ini berguna untuk pencadangan atau transfer data secara manual.</p>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button id="download-json-btn" class="btn-primary w-full md:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            <span>Unduh Cadangan (JSON)</span>
                        </button>
                        <div>
                            <label for="upload-json-input" class="btn-secondary cursor-pointer w-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                <span>Muat dari Cadangan (JSON)</span>
                            </label>
                            <input type="file" id="upload-json-input" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="sim-params-modal" class="modal-overlay"><div class="modal-content"><h3 class="text-2xl font-semibold mb-6">Parameter Simulasi</h3><form id="sim-params-form"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" id="stock-code" value="BBCA" class="hidden"><input type="number" id="initial-price" value="9500" class="hidden"><input type="number" id="initial-lot" value="10" class="hidden"><input type="number" id="dividend" value="227" class="hidden"><input type="number" id="avg-down-percent" value="15" class="hidden"><input type="number" id="avg-levels" value="5" class="hidden"><input type="number" id="tp1-percent" value="20" class="hidden"><input type="number" id="tp2-percent" value="50" class="hidden"><textarea id="sim-reason" class="hidden"></textarea><div><label for="modal-stock-code" class="block text-sm font-medium text-gray-300 mb-1">Kode Saham</label><input type="text" id="modal-stock-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-initial-price" class="block text-sm font-medium text-gray-300 mb-1">Harga Entry Awal (Rp)</label><input type="number" id="modal-initial-price" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-initial-lot" class="block text-sm font-medium text-gray-300 mb-1">Lot Entry Awal</label><input type="number" id="modal-initial-lot" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-dividend" class="block text-sm font-medium text-gray-300 mb-1">Dividen per Lembar (Rp)</label><input type="number" id="modal-dividend" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-avg-down-percent" class="block text-sm font-medium text-gray-300 mb-1">Avg. Down Setiap Turun (%)</label><input type="number" id="modal-avg-down-percent" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-avg-levels" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Tingkat Averaging</label><input type="number" id="modal-avg-levels" min="1" max="10" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-tp1-percent" class="block text-sm font-medium text-gray-300 mb-1">Target Profit 1 (%)</label><input type="number" id="modal-tp1-percent" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="modal-tp2-percent" class="block text-sm font-medium text-gray-300 mb-1">Target Profit 2 (%)</label><input type="number" id="modal-tp2-percent" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div class="md:col-span-2"><label for="modal-sim-reason" class="block text-sm font-medium text-gray-300 mb-1">Alasan Simulasi / Pembelian</label><textarea id="modal-sim-reason" rows="3" placeholder="Contoh: Saham defensif, prospek jangka panjang bagus..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></textarea></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" id="cancel-sim-params-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Batal</button><button type="button" id="save-simulation-from-modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Simpan</button><button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg">Terapkan</button></div></form></div></div>
    <div id="add-log-modal" class="modal-overlay"><div class="modal-content"><h3 class="text-2xl font-semibold mb-6">Tambah Catatan Transaksi</h3><form id="log-form" class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="log-stock-code" class="block text-sm font-medium text-gray-300 mb-1">Kode Saham</label><input type="text" id="log-stock-code" placeholder="Contoh: BBRI" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="log-buy-date" class="block text-sm font-medium text-gray-300 mb-1">Tanggal Beli</label><input type="date" id="log-buy-date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-gray-400"></div><div><label for="log-buy-price" class="block text-sm font-medium text-gray-300 mb-1">Harga Beli (per lembar)</label><input type="number" id="log-buy-price" placeholder="Contoh: 5500" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div><label for="log-buy-lot" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Lot</label><input type="number" id="log-buy-lot" placeholder="Contoh: 10" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div class="md:col-span-2"><label for="log-reason" class="block text-sm font-medium text-gray-300 mb-1">Alasan Pembelian</label><textarea id="log-reason" rows="3" placeholder="Contoh: Prospek dividen bagus, valuasi murah..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></textarea></div><div class="md:col-span-2 flex justify-end space-x-4"><button type="button" id="cancel-add-log-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Batal</button><button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg">Tambah</button></div></form></div></div>
    <div id="sell-modal" class="modal-overlay"><div class="modal-content"><h3 class="text-2xl font-semibold mb-4">Realisasi Posisi</h3><form id="sell-form"><input type="hidden" id="sell-log-index"><div class="mb-4"><label for="sell-price" class="block text-sm font-medium text-gray-300 mb-1">Harga Jual (per lembar)</label><input type="number" id="sell-price" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5"></div><div class="mb-6"><label for="sell-date" class="block text-sm font-medium text-gray-300 mb-1">Tanggal Jual</label><input type="date" id="sell-date" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-gray-400"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-sell-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Batal</button><button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Konfirmasi Jual</button></div></form></div></div>
    <div id="notification-modal" class="modal-overlay"><div class="modal-content max-w-sm"><h3 id="notification-title" class="text-2xl font-semibold mb-4 text-yellow-300">Pemberitahuan</h3><p id="notification-message" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button type="button" id="notification-ok-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg">OK</button></div></div></div>

    <script type="module">
        // --- DATA STORAGE ---
        let portfolioLog = [];
        let savedSimulations = [];
        let performanceChart;
        let currentMarketPrices = {};
        let currentUser = null;
        let autoSaveTimer = null;


        // --- DOM Elements ---
        const tabButtons = { 
            simulator: document.getElementById('tab-btn-simulator'), 
            log: document.getElementById('tab-btn-log'), 
            saved: document.getElementById('tab-btn-saved'), 
            performance: document.getElementById('tab-btn-performance'),
            backup: document.getElementById('tab-btn-backup') 
        };
        const tabContents = { 
            simulator: document.getElementById('tab-content-simulator'), 
            log: document.getElementById('tab-content-log'), 
            saved: document.getElementById('tab-content-saved'), 
            performance: document.getElementById('tab-content-performance'),
            backup: document.getElementById('tab-content-backup')
        };
        
        // Modal Elements
        const simParamsModal = document.getElementById('sim-params-modal');
        const addLogModal = document.getElementById('add-log-modal');
        const sellModal = document.getElementById('sell-modal');
        const notificationModal = document.getElementById('notification-modal');

        // Form Elements
        const simParamsForm = document.getElementById('sim-params-form');
        const logForm = document.getElementById('log-form');
        const sellForm = document.getElementById('sell-form');

        // Auth & Sync Elements
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const syncStatusSpan = document.getElementById('sync-status');

        // Backup Elements
        const downloadJsonBtn = document.getElementById('download-json-btn');
        const uploadJsonInput = document.getElementById('upload-json-input');

        // --- HELPER FUNCTIONS ---
        function formatCurrency(value, withSign = false) {
            const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.abs(value));
            if (!withSign) return formatted;
            if (value > 0) return `+${formatted}`;
            if (value < 0) return `-${formatted}`;
            return formatted;
        }

        // --- TAB MANAGEMENT ---
        function switchTab(tabName) {
            Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
            Object.values(tabContents).forEach(content => content.classList.remove('active'));
            tabButtons[tabName].classList.add('active');
            tabContents[tabName].classList.add('active');
        }

        // --- AUTHENTICATION ---
        async function handleGoogleLogin() {
            try {
                await window.firebase.signInWithPopup(window.firebase.auth, window.firebase.provider);
            } catch (error) {
                console.error("Error during login:", error);
                showNotification(`Login gagal: ${error.message}`, 'Error');
            }
        }

        async function handleLogout() {
            if (!confirm('Apakah Anda yakin ingin logout? Data yang belum tersimpan mungkin hilang.')) {
                return;
            }
            try {
                await window.firebase.signOut(window.firebase.auth);
                showNotification('Logout berhasil.', 'Sukses');
                resetAllData();
            } catch (error) {
                console.error("Error during logout:", error);
                showNotification(`Logout gagal: ${error.message}`, 'Error');
            }
        }
        
        function updateUIForAuthState(user) {
            currentUser = user;
            if (user) {
                loginBtn.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                userInfoDiv.classList.add('flex');
                userNameSpan.textContent = user.displayName || user.email;
            } else {
                loginBtn.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                userInfoDiv.classList.remove('flex');
                userNameSpan.textContent = '';
                syncStatusSpan.classList.add('opacity-0');
            }
        }

        // --- FIREBASE DATA SYNC (AUTOMATED) ---
        function triggerAutoSave() {
            if (!currentUser) return;
            
            syncStatusSpan.textContent = 'Menyimpan...';
            syncStatusSpan.classList.remove('opacity-0');

            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(async () => {
                const dataToSave = {
                    portfolioLog: portfolioLog,
                    savedSimulations: savedSimulations,
                    initialEquity: document.getElementById('initial-equity').value,
                    currentMarketPrices: currentMarketPrices,
                    simulationReason: document.getElementById('sim-reason').value,
                    updatedAt: new Date().toISOString()
                };

                try {
                    const userDocRef = window.firebase.doc(window.firebase.db, "portfolios", currentUser.uid);
                    await window.firebase.setDoc(userDocRef, dataToSave);
                    syncStatusSpan.textContent = 'Tersimpan ✓';
                    setTimeout(() => syncStatusSpan.classList.add('opacity-0'), 2000);
                } catch (error) {
                    console.error("Error auto-saving data to Firestore: ", error);
                    syncStatusSpan.textContent = 'Gagal menyimpan';
                    syncStatusSpan.classList.add('text-red-500');
                }
            }, 1500);
        }
        
        async function loadDataFromFirebase() {
            if (!currentUser) return;

            try {
                const userDocRef = window.firebase.doc(window.firebase.db, "portfolios", currentUser.uid);
                const docSnap = await window.firebase.getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    portfolioLog = data.portfolioLog || [];
                    savedSimulations = data.savedSimulations || [];
                    document.getElementById('initial-equity').value = data.initialEquity || "100000000";
                    currentMarketPrices = data.currentMarketPrices || {};
                    document.getElementById('sim-reason').value = data.simulationReason || '';
                    
                    refreshAllApplicationData();
                    showNotification('Data berhasil dimuat dari cloud!', 'Sukses');
                } else {
                    showNotification('Selamat datang! Tidak ada data cloud yang ditemukan, Anda bisa mulai dari awal.');
                    resetAllData();
                }
            } catch (error) {
                console.error("Error loading data from Firestore: ", error);
                showNotification(`Gagal memuat data: ${error.message}`, 'Error');
            }
        }

        // --- LOCAL JSON BACKUP/RESTORE ---
        function downloadJSON() {
            const dataToSave = {
                portfolioLog: portfolioLog,
                savedSimulations: savedSimulations,
                initialEquity: document.getElementById('initial-equity').value,
                currentMarketPrices: currentMarketPrices,
                simulationReason: document.getElementById('sim-reason').value,
            };
            const dataStr = JSON.stringify(dataToSave, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `portfolio_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Ini akan menimpa data Anda saat ini. Lanjutkan?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && typeof data === 'object') {
                        portfolioLog = data.portfolioLog || [];
                        savedSimulations = data.savedSimulations || [];
                        document.getElementById('initial-equity').value = data.initialEquity || "100000000";
                        currentMarketPrices = data.currentMarketPrices || {};
                        document.getElementById('sim-reason').value = data.simulationReason || '';

                        refreshAllApplicationData();
                        showNotification('Data berhasil dimuat dari file JSON!', 'Sukses');
                    } else {
                        throw new Error('Invalid JSON structure');
                    }
                } catch (error) {
                    showNotification(`Gagal memuat file: ${error.message}`, 'Error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }
        
        // --- DATA MANAGEMENT ---
        function resetAllData() {
            portfolioLog = [];
            savedSimulations = [];
            currentMarketPrices = {};
            document.getElementById('initial-equity').value = "100000000";
            document.getElementById('sim-reason').value = "";
            refreshAllApplicationData();
        }

        function refreshAllApplicationData() {
            renderLogTable();
            renderFinancialSummaries();
            renderSavedSimulationsTable();
            calculateDashboard();
            calculateEntryForProfit();
            updateSimulationReasonDisplay();
            triggerAutoSave();
        }


        // --- SIMULATOR CALCULATIONS & DISPLAY ---
        function updateActiveSimDisplay() {
            const displayContainer = document.getElementById('active-sim-params-display');
            displayContainer.innerHTML = `
                <div><span class="font-semibold text-gray-400">Kode:</span> <span class="text-cyan-300">${document.getElementById('stock-code').value.toUpperCase()}</span></div>
                <div><span class="font-semibold text-gray-400">Harga Awal:</span> ${formatCurrency(document.getElementById('initial-price').value)}</div>
                <div><span class="font-semibold text-gray-400">Lot Awal:</span> ${document.getElementById('initial-lot').value}</div>
                <div><span class="font-semibold text-gray-400">Avg. Down:</span> ${document.getElementById('avg-down-percent').value}%</div>
            `;
        }
        
        function updateSimulationReasonDisplay() {
            const reasonCard = document.getElementById('simulation-reason-card');
            const reasonDisplay = document.getElementById('simulation-reason-display');
            const reasonText = document.getElementById('sim-reason').value;

            if (reasonText && reasonText.trim() !== '') {
                reasonDisplay.textContent = reasonText;
                reasonCard.classList.remove('hidden');
            } else {
                reasonCard.classList.add('hidden');
            }
        }

        function calculateDashboard() {
            const initialPrice = parseFloat(document.getElementById('initial-price').value) || 0;
            const initialLot = parseFloat(document.getElementById('initial-lot').value) || 0;
            const dividend = parseFloat(document.getElementById('dividend').value) || 0;
            const avgDownPercent = parseFloat(document.getElementById('avg-down-percent').value) || 0;
            const avgLevels = parseInt(document.getElementById('avg-levels').value) || 0;
            const tp1Percent = parseFloat(document.getElementById('tp1-percent').value) || 0;
            const tp2Percent = parseFloat(document.getElementById('tp2-percent').value) || 0;
            const tableBody = document.getElementById('scenario-table-body');
            tableBody.innerHTML = ''; 
            let cumulativeCost = 0, cumulativeShares = 0, currentPrice = initialPrice;
            for (let i = 0; i <= avgLevels; i++) {
                let entryPrice, lotsToBuy;
                if (i === 0) { entryPrice = initialPrice; lotsToBuy = initialLot; } else { entryPrice = currentPrice * (1 - avgDownPercent / 100); lotsToBuy = initialLot; }
                if (lotsToBuy <= 0 || entryPrice <= 0) continue;
                const sharesToBuy = lotsToBuy * 100;
                const totalBuy = entryPrice * sharesToBuy;
                cumulativeCost += totalBuy; cumulativeShares += sharesToBuy;
                const avgPrice = cumulativeCost / cumulativeShares;
                const dividendYield = dividend > 0 && entryPrice > 0 ? (dividend / entryPrice) * 100 : 0;
                const tp1Price = avgPrice * (1 + tp1Percent / 100);
                const tp2Price = avgPrice * (1 + tp2Percent / 100);
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                row.innerHTML = `<td class="px-6 py-4 font-medium whitespace-nowrap">${i === 0 ? 'Entry Awal' : `AVG ${i}`}</td><td class="px-6 py-4 font-semibold text-yellow-300">${formatCurrency(entryPrice)}</td><td class="px-6 py-4">${lotsToBuy}</td><td class="px-6 py-4">${formatCurrency(totalBuy)}</td><td class="px-6 py-4 ${dividendYield > 5 ? 'text-green-400' : 'text-gray-300'}">${dividendYield.toFixed(2)}%</td><td class="px-6 py-4 font-semibold text-blue-300">${formatCurrency(avgPrice)}</td><td class="px-6 py-4 text-green-400">${formatCurrency(tp1Price)}</td><td class="px-6 py-4 text-green-500">${formatCurrency(tp2Price)}</td>`;
                tableBody.appendChild(row);
                currentPrice = entryPrice;
            }
            const totalInvestment = cumulativeCost;
            const totalLots = cumulativeShares / 100;
            const finalAvgPrice = totalInvestment / (totalLots * 100) || 0;
            document.getElementById('summary-total-investment').textContent = formatCurrency(totalInvestment);
            document.getElementById('summary-total-lot').textContent = totalLots;
            document.getElementById('summary-avg-price').textContent = formatCurrency(finalAvgPrice);
        }
        function calculateEntryForProfit() {
            const targetProfitRp = parseFloat(document.getElementById('target-profit-rp').value) || 0;
            const targetProfitLot = parseFloat(document.getElementById('target-profit-lot').value) || 0;
            const targetProfitPercent = parseFloat(document.getElementById('target-profit-percent').value) || 0;
            if (targetProfitLot <= 0 || targetProfitPercent <= 0) { document.getElementById('entry-price-result').textContent = 'Input tidak valid'; return; }
            const entryPrice = targetProfitRp / (targetProfitLot * 100 * (targetProfitPercent / 100));
            document.getElementById('entry-price-result').textContent = formatCurrency(entryPrice);
        }

        // --- PORTFOLIO LOG & SUMMARY MANAGEMENT ---
        function renderLogTable() {
            const logTableBody = document.getElementById('log-table-body');
            logTableBody.innerHTML = '';
            if (portfolioLog.length === 0) { logTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">Belum ada catatan transaksi.</td></tr>`; return; }
            portfolioLog.forEach((log, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700';
                let plHtml, statusHtml, actionHtml, sellDateHtml;

                if (log.sellPrice) {
                    const profitLoss = (log.sellPrice - log.price) * log.lot * 100;
                    const plColor = profitLoss >= 0 ? 'text-green-400' : 'text-red-500';
                    plHtml = `<td class="px-6 py-4 font-semibold ${plColor}">${formatCurrency(profitLoss, true)}</td>`;
                    statusHtml = `<td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-700 text-gray-300">Closed</span></td>`;
                    actionHtml = `<td class="px-6 py-4"><button class="delete-log-btn text-red-500 hover:text-red-400" data-index="${index}">Hapus</button></td>`;
                    sellDateHtml = `<td class="px-6 py-4">${log.sellDate}</td>`;
                } else {
                    plHtml = `<td class="px-6 py-4 text-gray-500">-</td>`;
                    statusHtml = `<td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-900 text-blue-300">Open</span></td>`;
                    actionHtml = `<td class="px-6 py-4 space-x-2"><button class="sell-log-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded" data-index="${index}">Jual</button><button class="delete-log-btn text-gray-500 hover:text-red-400" data-index="${index}">Hapus</button></td>`;
                    sellDateHtml = `<td class="px-6 py-4 text-gray-500">-</td>`;
                }
                row.innerHTML = `
                    <td class="px-6 py-4">${log.date}</td>
                    <td class="px-6 py-4 font-medium text-cyan-300">${log.code.toUpperCase()}</td>
                    <td class="px-6 py-4">${formatCurrency(log.price)}</td>
                    <td class="px-6 py-4">${log.lot}</td>
                    ${statusHtml}
                    ${sellDateHtml}
                    ${plHtml}
                    ${actionHtml}
                `;
                logTableBody.appendChild(row);
            });
        }
        
        function renderFinancialSummaries() {
            const summaryContainer = document.getElementById('portfolio-summary-by-stock');
            const grandTotalContainer = document.getElementById('portfolio-grand-total');
            const realizedPlContainer = document.getElementById('realized-pl-summary');
            const currentEquityDisplay = document.getElementById('current-equity-display');
            
            summaryContainer.innerHTML = ''; grandTotalContainer.innerHTML = ''; realizedPlContainer.innerHTML = '';

            const initialEquity = parseFloat(document.getElementById('initial-equity').value) || 0;
            let totalBuyCost = 0;
            let totalSellValue = 0;
            
            portfolioLog.forEach(log => {
                totalBuyCost += log.price * log.lot * 100;
                if(log.sellPrice) {
                    totalSellValue += log.sellPrice * log.lot * 100;
                }
            });

            const currentEquity = initialEquity - totalBuyCost + totalSellValue;
            currentEquityDisplay.textContent = formatCurrency(currentEquity);

            const openPositions = portfolioLog.filter(log => !log.sellPrice);
            const closedPositions = portfolioLog.filter(log => log.sellPrice);
            
            if (openPositions.length === 0) {
                summaryContainer.innerHTML = `<p class="text-gray-500 text-center">Tidak ada posisi terbuka.</p>`;
                grandTotalContainer.innerHTML = `<div class="p-4 bg-gray-600 rounded-lg text-center"><h4 class="text-gray-300 font-medium">Total Investasi (Open)</h4><p class="text-2xl font-bold text-yellow-400 mt-1">${formatCurrency(0)}</p></div>`;
            } else {
                const summary = openPositions.reduce((acc, log) => {
                    const code = log.code.toUpperCase();
                    if (!acc[code]) { acc[code] = { totalLots: 0, totalCost: 0 }; }
                    acc[code].totalLots += log.lot;
                    acc[code].totalCost += log.price * log.lot * 100;
                    return acc;
                }, {});
                let grandTotalCost = 0;
                Object.entries(summary).forEach(([code, data]) => {
                    grandTotalCost += data.totalCost;
                    const avgPrice = data.totalCost / (data.totalLots * 100);
                    const priceValue = currentMarketPrices[code] || '';
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'p-4 bg-gray-700/50 rounded-lg';
                    summaryCard.innerHTML = `<h4 class="font-bold text-lg text-cyan-300">${code}</h4><div class="flex justify-between text-sm mt-2"><span class="text-gray-400">Total Lot:</span><span class="font-semibold">${data.totalLots}</span></div><div class="flex justify-between text-sm mt-1"><span class="text-gray-400">Harga Rata-rata:</span><span class="font-semibold">${formatCurrency(avgPrice)}</span></div><div class="flex justify-between text-sm mt-1"><span class="text-gray-400">Total Investasi:</span><span class="font-semibold">${formatCurrency(data.totalCost)}</span></div><div class="flex justify-between items-center text-sm mt-2"><label for="current-price-${code}" class="text-gray-400">Harga Saat Ini:</label><input type="number" id="current-price-${code}" data-code="${code}" class="current-price-input w-24 bg-gray-800 border border-gray-600 rounded p-1 text-right" placeholder="0" value="${priceValue}"></div><div class="flex justify-between text-sm mt-1"><span class="text-gray-400">Floating P/L:</span><span id="floating-pl-${code}" class="font-semibold">-</span></div>`;
                    summaryContainer.appendChild(summaryCard);
                });
                const grandTotalCard = document.createElement('div');
                grandTotalCard.className = 'p-4 bg-gray-600 rounded-lg text-center';
                grandTotalCard.innerHTML = `<h4 class="text-gray-300 font-medium">Total Investasi (Open)</h4><p class="text-2xl font-bold text-yellow-400 mt-1">${formatCurrency(grandTotalCost)}</p>`;
                grandTotalContainer.appendChild(grandTotalCard);
            }

            const totalRealizedPL = closedPositions.reduce((acc, log) => acc + ((log.sellPrice - log.price) * log.lot * 100), 0);
            const realizedPlCard = document.createElement('div');
            realizedPlCard.className = 'p-4 bg-gray-600 rounded-lg text-center';
            const plColor = totalRealizedPL >= 0 ? 'text-green-400' : 'text-red-500';
            realizedPlCard.innerHTML = `<h4 class="text-gray-300 font-medium">Total Realisasi P/L</h4><p class="text-2xl font-bold ${plColor} mt-1">${formatCurrency(totalRealizedPL, true)}</p>`;
            realizedPlContainer.appendChild(realizedPlCard);
            
            calculateAndRenderFloatingPL();
            renderPerformanceTab();
        }

        function calculateAndRenderFloatingPL() {
            const openPositions = portfolioLog.filter(log => !log.sellPrice);
            const floatingPlContainer = document.getElementById('floating-pl-summary');
            if (openPositions.length === 0) { floatingPlContainer.innerHTML = ''; renderPerformanceTab(); return; }
            
            const summary = openPositions.reduce((acc, log) => {
                const code = log.code.toUpperCase();
                if (!acc[code]) { acc[code] = { totalLots: 0, totalCost: 0 }; }
                acc[code].totalLots += log.lot;
                acc[code].totalCost += log.price * log.lot * 100;
                return acc;
            }, {});

            let totalFloatingPL = 0;
            Object.entries(summary).forEach(([code, data]) => {
                const currentPriceInput = document.getElementById(`current-price-${code}`);
                if (!currentPriceInput) return;
                const currentPrice = parseFloat(currentPriceInput.value) || 0;
                const floatingPlElement = document.getElementById(`floating-pl-${code}`);
                if (currentPrice > 0) {
                    const avgPrice = data.totalCost / (data.totalLots * 100);
                    const floatingPL = (currentPrice - avgPrice) * data.totalLots * 100;
                    totalFloatingPL += floatingPL;
                    const plColor = floatingPL >= 0 ? 'text-green-400' : 'text-red-500';
                    floatingPlElement.className = `font-semibold ${plColor}`;
                    floatingPlElement.textContent = formatCurrency(floatingPL, true);
                } else {
                    floatingPlElement.textContent = '-';
                }
            });

            const plColor = totalFloatingPL >= 0 ? 'text-green-400' : 'text-red-500';
            floatingPlContainer.innerHTML = `<div class="p-4 bg-gray-600 rounded-lg text-center"><h4 class="text-gray-300 font-medium">Total Floating P/L</h4><p class="text-2xl font-bold ${plColor} mt-1">${formatCurrency(totalFloatingPL, true)}</p></div>`;
            renderPerformanceTab();
        }

        // --- PERFORMANCE TAB MANAGEMENT ---
        function renderPerformanceTab() {
            const tableBody = document.getElementById('performance-table-body');
            tableBody.innerHTML = '';

            const initialEquity = parseFloat(document.getElementById('initial-equity').value) || 0;
            if (initialEquity <= 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">Masukkan modal awal untuk menghitung performa.</td></tr>`;
                if (performanceChart) performanceChart.destroy();
                return;
            }

            let totalBuyCost = 0, totalSellValue = 0;
            portfolioLog.forEach(log => {
                totalBuyCost += log.price * log.lot * 100;
                if (log.sellPrice) totalSellValue += log.sellPrice * log.lot * 100;
            });
            const currentEquity = initialEquity - totalBuyCost + totalSellValue;

            const openPositions = portfolioLog.filter(log => !log.sellPrice);
            let valueOfOpenPositions = 0;
            const summary = openPositions.reduce((acc, log) => {
                const code = log.code.toUpperCase();
                if (!acc[code]) acc[code] = { totalLots: 0 };
                acc[code].totalLots += log.lot;
                return acc;
            }, {});

            Object.entries(summary).forEach(([code, data]) => {
                const currentPrice = currentMarketPrices[code] || 0;
                if (currentPrice > 0) valueOfOpenPositions += parseFloat(currentPrice) * data.totalLots * 100;
            });

            const currentTotalValue = currentEquity + valueOfOpenPositions;
            const allTimeReturn = ((currentTotalValue / initialEquity) - 1) * 100;

            const periods = ['1 Bulan', '3 Bulan', '6 Bulan', '9 Bulan', '12 Bulan', 'YTD', '3 Tahun', '5 Tahun', 'All Time'];

            periods.forEach(period => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700';
                const isAllTime = period === 'All Time';
                const portfolioPerformance = isAllTime ? allTimeReturn : NaN;
                const performanceCell = isAllTime && isFinite(portfolioPerformance) ? `<td class="px-6 py-4 font-semibold ${portfolioPerformance >= 0 ? 'text-green-400' : 'text-red-500'}">${portfolioPerformance.toFixed(2)}%</td>` : `<td class="px-6 py-4 text-gray-500">N/A</td>`;
                row.innerHTML = `<td class="px-6 py-4 font-medium">${period}</td>${performanceCell}<td class="px-6 py-4"><input type="number" class="performance-ihsg-input w-24 bg-gray-700 border border-gray-600 rounded p-1 text-right" data-period="${period}" placeholder="0.00"></td><td class="px-6 py-4 font-semibold" id="performance-diff-${period.replace(/\s+/g, '')}">-</td>`;
                tableBody.appendChild(row);
            });
            renderPerformanceChart();
        }

        function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const periods = ['1 Bulan', '3 Bulan', '6 Bulan', '9 Bulan', '12 Bulan', 'YTD', '3 Tahun', '5 Tahun', 'All Time'];
            
            const initialEquity = parseFloat(document.getElementById('initial-equity').value) || 0;
            let allTimeReturn = NaN;
            if (initialEquity > 0) {
                let totalBuyCost = 0, totalSellValue = 0;
                portfolioLog.forEach(log => {
                    totalBuyCost += log.price * log.lot * 100;
                    if (log.sellPrice) totalSellValue += log.sellPrice * log.lot * 100;
                });
                const currentEquity = initialEquity - totalBuyCost + totalSellValue;
                const openPositions = portfolioLog.filter(log => !log.sellPrice);
                let valueOfOpenPositions = 0;
                const summary = openPositions.reduce((acc, log) => {
                    const code = log.code.toUpperCase();
                    if (!acc[code]) acc[code] = { totalLots: 0 };
                    acc[code].totalLots += log.lot;
                    return acc;
                }, {});
                Object.entries(summary).forEach(([code, data]) => {
                    const currentPrice = currentMarketPrices[code] || 0;
                    if (currentPrice > 0) valueOfOpenPositions += parseFloat(currentPrice) * data.totalLots * 100;
                });
                const currentTotalValue = currentEquity + valueOfOpenPositions;
                allTimeReturn = ((currentTotalValue / initialEquity) - 1) * 100;
            }

            const portfolioData = periods.map(p => p === 'All Time' && isFinite(allTimeReturn) ? allTimeReturn : null);
            const ihsgData = periods.map(p => {
                const input = document.querySelector(`.performance-ihsg-input[data-period="${p}"]`);
                return input ? (parseFloat(input.value) || null) : null;
            });

            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: periods,
                    datasets: [
                        {
                            label: 'Performa Portofolio (%)',
                            data: portfolioData,
                            backgroundColor: 'rgba(34, 211, 238, 0.6)',
                            borderColor: 'rgba(34, 211, 238, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Performa IHSG (%)',
                            data: ihsgData,
                            backgroundColor: 'rgba(74, 85, 104, 0.6)',
                            borderColor: 'rgba(74, 85, 104, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9CA3AF' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: '#374151' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#D1D5DB' }
                        }
                    }
                }
            });
        }

        function calculatePerformanceDifference() {
             const initialEquity = parseFloat(document.getElementById('initial-equity').value) || 0;
             if (initialEquity <= 0) return;

             let totalBuyCost = 0, totalSellValue = 0;
             portfolioLog.forEach(log => {
                totalBuyCost += log.price * log.lot * 100;
                if (log.sellPrice) totalSellValue += log.sellPrice * log.lot * 100;
             });
             const currentEquity = initialEquity - totalBuyCost + totalSellValue;

             const openPositions = portfolioLog.filter(log => !log.sellPrice);
             let valueOfOpenPositions = 0;
             const summary = openPositions.reduce((acc, log) => {
                const code = log.code.toUpperCase();
                if (!acc[code]) acc[code] = { totalLots: 0 };
                acc[code].totalLots += log.lot;
                return acc;
             }, {});
             Object.entries(summary).forEach(([code, data]) => {
                const currentPrice = currentMarketPrices[code] || 0;
                if (currentPrice > 0) valueOfOpenPositions += parseFloat(currentPrice) * data.totalLots * 100;
             });
             const currentTotalValue = currentEquity + valueOfOpenPositions;
             const allTimeReturn = ((currentTotalValue / initialEquity) - 1) * 100;

             document.querySelectorAll('.performance-ihsg-input').forEach(input => {
                const period = input.dataset.period;
                const diffCell = document.getElementById(`performance-diff-${period.replace(/\s+/g, '')}`);
                const ihsgPerf = parseFloat(input.value);

                if (!isNaN(ihsgPerf) && period === 'All Time' && isFinite(allTimeReturn)) {
                    const difference = allTimeReturn - ihsgPerf;
                    diffCell.className = `px-6 py-4 font-semibold ${difference >= 0 ? 'text-green-400' : 'text-red-500'}`;
                    diffCell.textContent = `${difference.toFixed(2)}%`;
                } else {
                    diffCell.textContent = '-';
                    diffCell.className = `px-6 py-4 font-semibold`;
                }
             });
             renderPerformanceChart();
        }
        
        // --- MODAL MANAGEMENT ---
        function openModal(modal) { modal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }

        function showNotification(message, title = 'Pemberitahuan') {
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            openModal(notificationModal);
        }

        // --- EVENT HANDLERS ---
        function handleAddLog(event) {
            event.preventDefault();
            const newLog = {
                id: Date.now(), code: document.getElementById('log-stock-code').value, date: document.getElementById('log-buy-date').value,
                price: parseFloat(document.getElementById('log-buy-price').value), lot: parseInt(document.getElementById('log-buy-lot').value),
                reason: document.getElementById('log-reason').value, sellPrice: null, sellDate: null,
            };
            if (!newLog.code || !newLog.date || !newLog.price || !newLog.lot) { showNotification('Harap isi semua kolom yang wajib diisi.'); return; }
            
            const transactionCost = newLog.price * newLog.lot * 100;
            const initialEquity = parseFloat(document.getElementById('initial-equity').value) || 0;
            let totalBuyCost = 0, totalSellValue = 0;
            portfolioLog.forEach(log => {
                totalBuyCost += log.price * log.lot * 100;
                if (log.sellPrice) totalSellValue += log.sellPrice * log.lot * 100;
            });
            const currentEquity = initialEquity - totalBuyCost + totalSellValue;

            if (transactionCost > currentEquity) {
                showNotification(`Transaksi gagal. Total pembelian (${formatCurrency(transactionCost)}) melebihi ekuitas yang tersedia (${formatCurrency(currentEquity)}).`);
                return;
            }

            portfolioLog.push(newLog);
            logForm.reset();
            closeModal(addLogModal);
            refreshAllApplicationData();
        }
        function handleDeleteLog(index) {
            portfolioLog.splice(index, 1);
            refreshAllApplicationData();
        }
        function handleSellSubmit(event) {
            event.preventDefault();
            const index = parseInt(document.getElementById('sell-log-index').value);
            const sellPrice = parseFloat(document.getElementById('sell-price').value);
            const sellDate = document.getElementById('sell-date').value;
            if (!isNaN(index) && sellPrice > 0 && sellDate) {
                portfolioLog[index].sellPrice = sellPrice;
                portfolioLog[index].sellDate = sellDate;
                closeModal(sellModal);
                refreshAllApplicationData();
            } else {
                showNotification('Harga jual dan tanggal tidak valid.');
            }
        }
        function handleSimParamsSubmit(event) {
            event.preventDefault();
            document.getElementById('stock-code').value = document.getElementById('modal-stock-code').value;
            document.getElementById('initial-price').value = document.getElementById('modal-initial-price').value;
            document.getElementById('initial-lot').value = document.getElementById('modal-initial-lot').value;
            document.getElementById('dividend').value = document.getElementById('modal-dividend').value;
            document.getElementById('avg-down-percent').value = document.getElementById('modal-avg-down-percent').value;
            document.getElementById('avg-levels').value = document.getElementById('modal-avg-levels').value;
            document.getElementById('tp1-percent').value = document.getElementById('modal-tp1-percent').value;
            document.getElementById('tp2-percent').value = document.getElementById('modal-tp2-percent').value;
            document.getElementById('sim-reason').value = document.getElementById('modal-sim-reason').value;
            
            calculateDashboard();
            updateActiveSimDisplay();
            updateSimulationReasonDisplay();
            closeModal(simParamsModal);
            triggerAutoSave();
        }
        function handleSaveSimulation(isFromModal = false) {
            const simulation = {
                id: Date.now(),
                stockCode: document.getElementById(isFromModal ? 'modal-stock-code' : 'stock-code').value,
                initialPrice: parseFloat(document.getElementById(isFromModal ? 'modal-initial-price' : 'initial-price').value),
                initialLot: parseFloat(document.getElementById(isFromModal ? 'modal-initial-lot' : 'initial-lot').value),
                dividend: parseFloat(document.getElementById(isFromModal ? 'modal-dividend' : 'dividend').value),
                avgDownPercent: parseFloat(document.getElementById(isFromModal ? 'modal-avg-down-percent' : 'avg-down-percent').value),
                avgLevels: parseInt(document.getElementById(isFromModal ? 'modal-avg-levels' : 'avg-levels').value),
                tp1Percent: parseFloat(document.getElementById(isFromModal ? 'modal-tp1-percent' : 'tp1-percent').value),
                tp2Percent: parseFloat(document.getElementById(isFromModal ? 'modal-tp2-percent' : 'tp2-percent').value),
                reason: document.getElementById(isFromModal ? 'modal-sim-reason' : 'sim-reason').value,
            };
            if (!simulation.stockCode) { showNotification('Kode saham tidak boleh kosong untuk menyimpan simulasi.'); return; }
            savedSimulations.push(simulation);
            renderSavedSimulationsTable();
            if (isFromModal) closeModal(simParamsModal);
            switchTab('saved');
            triggerAutoSave();
        }
        function handleLoadOrDeleteSimulation(event) {
            const target = event.target;
            const simId = parseInt(target.dataset.id);
            if (isNaN(simId)) return;

            if (target.classList.contains('load-sim-btn')) {
                const simToLoad = savedSimulations.find(s => s.id === simId);
                if (simToLoad) {
                    document.getElementById('stock-code').value = simToLoad.stockCode;
                    document.getElementById('initial-price').value = simToLoad.initialPrice;
                    document.getElementById('initial-lot').value = simToLoad.initialLot;
                    document.getElementById('dividend').value = simToLoad.dividend;
                    document.getElementById('avg-down-percent').value = simToLoad.avgDownPercent;
                    document.getElementById('avg-levels').value = simToLoad.avgLevels;
                    document.getElementById('tp1-percent').value = simToLoad.tp1Percent;
                    document.getElementById('tp2-percent').value = simToLoad.tp2Percent;
                    document.getElementById('sim-reason').value = simToLoad.reason || '';
                    
                    calculateDashboard();
                    updateActiveSimDisplay();
                    updateSimulationReasonDisplay();
                    switchTab('simulator');
                    triggerAutoSave();
                }
            } else if (target.classList.contains('delete-sim-btn')) {
                savedSimulations = savedSimulations.filter(s => s.id !== simId);
                renderSavedSimulationsTable();
                triggerAutoSave();
            }
        }
        function renderSavedSimulationsTable() {
            const tableBody = document.getElementById('saved-simulations-table-body');
            tableBody.innerHTML = '';
            if (savedSimulations.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-500">Belum ada simulasi yang disimpan.</td></tr>`; return; }
            savedSimulations.forEach(sim => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-cyan-300">${sim.stockCode.toUpperCase()}</td><td class="px-6 py-4">${formatCurrency(sim.initialPrice)}</td><td class="px-6 py-4">${sim.initialLot}</td><td class="px-6 py-4">${sim.avgDownPercent}%</td><td class="px-6 py-4">${sim.avgLevels}</td><td class="px-6 py-4 space-x-2"><button class="load-sim-btn text-green-400 hover:text-green-300" data-id="${sim.id}">Muat</button><button class="delete-sim-btn text-red-500 hover:text-red-400" data-id="${sim.id}">Hapus</button></td>`;
                tableBody.appendChild(row);
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('profit-calc-form').addEventListener('input', calculateEntryForProfit);
        logForm.addEventListener('submit', handleAddLog);
        simParamsForm.addEventListener('submit', handleSimParamsSubmit);
        sellForm.addEventListener('submit', handleSellSubmit);
        document.getElementById('initial-equity').addEventListener('input', () => {
            renderFinancialSummaries();
            triggerAutoSave();
        });
        
        document.getElementById('open-add-log-modal-btn').addEventListener('click', () => openModal(addLogModal));
        document.getElementById('cancel-add-log-btn').addEventListener('click', () => closeModal(addLogModal));

        document.getElementById('open-sim-params-modal-btn').addEventListener('click', () => {
            document.getElementById('modal-stock-code').value = document.getElementById('stock-code').value;
            document.getElementById('modal-initial-price').value = document.getElementById('initial-price').value;
            document.getElementById('modal-initial-lot').value = document.getElementById('initial-lot').value;
            document.getElementById('modal-dividend').value = document.getElementById('dividend').value;
            document.getElementById('modal-avg-down-percent').value = document.getElementById('avg-down-percent').value;
            document.getElementById('modal-avg-levels').value = document.getElementById('avg-levels').value;
            document.getElementById('modal-tp1-percent').value = document.getElementById('tp1-percent').value;
            document.getElementById('modal-tp2-percent').value = document.getElementById('tp2-percent').value;
            document.getElementById('modal-sim-reason').value = document.getElementById('sim-reason').value;
            openModal(simParamsModal);
        });
        document.getElementById('cancel-sim-params-btn').addEventListener('click', () => closeModal(simParamsModal));
        document.getElementById('save-simulation-from-modal-btn').addEventListener('click', () => handleSaveSimulation(true));
        document.getElementById('notification-ok-btn').addEventListener('click', () => closeModal(notificationModal));

        document.getElementById('log-table-body').addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-log-btn')) {
                const index = parseInt(event.target.dataset.index);
                if (confirm('Apakah Anda yakin ingin menghapus catatan ini?')) { handleDeleteLog(index); }
            } else if (event.target.classList.contains('sell-log-btn')) {
                const index = parseInt(event.target.dataset.index);
                document.getElementById('sell-log-index').value = index;
                document.getElementById('sell-date').value = new Date().toISOString().split('T')[0];
                openModal(sellModal);
            }
        });
        document.getElementById('cancel-sell-btn').addEventListener('click', () => closeModal(sellModal));
        
        document.getElementById('saved-simulations-table-body').addEventListener('click', handleLoadOrDeleteSimulation);
        
        Object.keys(tabButtons).forEach(key => {
            tabButtons[key].addEventListener('click', () => switchTab(key));
        });
        
        document.getElementById('portfolio-summary-by-stock').addEventListener('input', (event) => {
            if (event.target.classList.contains('current-price-input')) {
                const code = event.target.dataset.code;
                currentMarketPrices[code] = event.target.value;
                calculateAndRenderFloatingPL();
                triggerAutoSave();
            }
        });

        document.getElementById('tab-content-performance').addEventListener('input', (event) => {
             if (event.target.classList.contains('performance-ihsg-input')) {
                calculatePerformanceDifference();
            }
        });

        // New listeners for Auth, Sync, and Backup
        loginBtn.addEventListener('click', handleGoogleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        downloadJsonBtn.addEventListener('click', downloadJSON);
        uploadJsonInput.addEventListener('change', handleFileUpload);
        
        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            document.getElementById('log-buy-date').value = new Date().toISOString().split('T')[0];
            
            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                const wasNotLoggedIn = !currentUser;
                updateUIForAuthState(user);
                if (user && wasNotLoggedIn) {
                    loadDataFromFirebase();
                }
            });

            refreshAllApplicationData();
            switchTab('simulator');
        });
    </script>
</body>
</html>
